<div class="feed-container">
  <!-- Loading State (Initial Load) -->
  @if (isLoading() && posts().length === 0) {
  <div class="loading-state">
    <div class="loading-content">
      <div class="spinner-wrapper">
        <mat-spinner diameter="48"></mat-spinner>
      </div>
      <p class="loading-text">Loading your feed...</p>
    </div>
  </div>
  }

  <!-- Error State -->
  @if (error() !== null && posts().length === 0) {
  <div class="error-state">
    <div class="error-icon-wrapper">
      <mat-icon>cloud_off</mat-icon>
    </div>
    <h2>Something went wrong</h2>
    <p>{{ error() }}</p>
    <button class="retry-btn" (click)="refreshFeed()">
      <mat-icon>refresh</mat-icon>
      Try Again
    </button>
  </div>
  }

  <!-- Empty State -->
  @if (!isLoading() && error() === null && posts().length === 0) {
  <div class="empty-state">
    <div class="empty-icon-wrapper">
      <mat-icon>explore</mat-icon>
    </div>
    <h2>Welcome to 01Blog!</h2>
    <p>Your feed is empty. Start following users to see their posts here.</p>
    <div class="empty-actions">
      <a class="primary-action-btn" routerLink="/users">
        <mat-icon>search</mat-icon>
        Discover Users
      </a>
      <a class="secondary-action-btn" routerLink="/posts/create">
        <mat-icon>add</mat-icon>
        Create Post
      </a>
    </div>
  </div>
  }

  <!-- Posts Feed -->
  @if (posts().length > 0) {
  <div class="posts-grid">
    @for (post of posts(); track post.id) {
    <article class="post-card" (click)="navigateToPost(post.id)">
      <!-- Post Media (if exists) -->
      @if (post.mediaUrl) {
      <div class="post-media">
        @if (post.mediaType === 'image') {
        <img
          [src]="getMediaUrl(post.mediaUrl)"
          [alt]="post.title"
          class="media-image"
          loading="lazy"
        />
        } @else if (post.mediaType === 'video') {
        <div class="video-wrapper">
          <video [src]="getMediaUrl(post.mediaUrl)" class="media-video" preload="metadata"></video>
          <div class="video-overlay">
            <mat-icon class="play-icon">play_circle</mat-icon>
          </div>
        </div>
        }
      </div>
      }

      <!-- Post Content -->
      <div class="post-body">
        <!-- Author Info -->
        <div class="post-author">
          <a
            [routerLink]="['/profile', post.user.username]"
            class="author-avatar"
            (click)="$event.stopPropagation()"
          >
            @if (post.user.avatar) { @if (post.user.id === connectedUser()?.id) {
            <img [src]="getMediaUrl(connectedUser()?.avatar)" [alt]="post.user.fullName" />
            } @else {
            <img [src]="getMediaUrl(post.user.avatar)" [alt]="post.user.fullName" />
            } } @else {
            <div class="avatar-placeholder">
              {{ getAuthorInitials(post.user.fullName) }}
            </div>
            }
          </a>

          <div class="author-details">
            <a
              [routerLink]="['/profile', post.user.username]"
              class="author-name"
              (click)="$event.stopPropagation()"
            >
              {{ post.user.fullName }}
            </a>
            <span class="post-time">{{ post.createdAt | timeAgo }}</span>
          </div>
        </div>

        <!-- Post Title -->
        <h2 class="post-title">{{ post.title }}</h2>

        <!-- Post Content -->
        <p class="post-content">{{ post.content }}</p>

        <!-- Post Actions -->
        <div class="post-actions">
          <button
            class="action-btn"
            [class.active]="post.isLiked"
            (click)="onLikePost(post, $event)"
            matRipple
          >
            @if(post.isLiked){
            <mat-icon>
              <svg id="heart-solid" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <polygon
                  points="23 6 23 11 22 11 22 12 21 12 21 13 20 13 20 14 19 14 19 15 18 15 18 16 17 16 17 17 16 17 16 18 15 18 15 19 14 19 14 20 13 20 13 21 11 21 11 20 10 20 10 19 9 19 9 18 8 18 8 17 7 17 7 16 6 16 6 15 5 15 5 14 4 14 4 13 3 13 3 12 2 12 2 11 1 11 1 6 2 6 2 5 3 5 3 4 4 4 4 3 10 3 10 4 11 4 11 5 13 5 13 4 14 4 14 3 20 3 20 4 21 4 21 5 22 5 22 6 23 6"
                />
              </svg>
            </mat-icon>
            }@else{
            <mat-icon>
              <svg id="heart" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                  d="m22,6v-1h-1v-1h-1v-1h-6v1h-1v1h-2v-1h-1v-1h-6v1h-1v1h-1v1h-1v5h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h2v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-5h-1Zm-2,4v1h-1v1h-1v1h-1v1h-1v1h-1v1h-1v1h-1v1h-2v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-3h1v-1h1v-1h4v1h1v1h1v1h2v-1h1v-1h1v-1h4v1h1v1h1v3h-1Z"
                />
              </svg>
            </mat-icon>

            }
            <span>{{ post.likesCount }}</span>
          </button>

          <button class="action-btn" matRipple>
            <mat-icon>chat_bubble_outline</mat-icon>
            <span>{{ post.commentsCount }}</span>
          </button>

          <!-- <button class="action-btn" matRipple>
            <mat-icon>bookmark_border</mat-icon>
          </button> -->
        </div>
      </div>
    </article>

    @if (post == posts()[posts().length - 1]) {
    <div #loadTrigger class="load-trigger"></div>
    @defer (on viewport(loadTrigger)) {
    {{ onTriggerVisible() }}
    } @placeholder {
    <div class="load-more-indicator">
      <mat-spinner diameter="32"></mat-spinner>
      <p>Loading more posts...</p>
    </div>
    } } }
  </div>

  <!-- Load More Indicator -->
  @if (isLoadingMore() || (isLoading() && posts().length > 0)) {
  <div class="load-more-indicator">
    <mat-spinner diameter="32"></mat-spinner>
    <p>Loading more posts...</p>
  </div>
  }

  <!-- End of Feed -->
  @if (!hasMore() && !isLoading()) {
  <div class="end-of-feed">
    <mat-icon>check_circle</mat-icon>
    <p>You're all caught up!</p>
  </div>
  } }
</div>
