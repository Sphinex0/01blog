<div class="admin-dashboard">
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-icon">üëë</div>

      <div>
        <h1 class="header-title">ADMIN PANEL</h1>

        <p class="header-subtitle">MODERATE & MANAGE</p>
      </div>
    </div>

    <button
      mat-raised-button
      class="refresh-btn pixel-btn"
      (click)="loadStats(); loadUsers(true); loadPosts(true); loadReports(true)"
    >
      <mat-icon>refresh</mat-icon> REFRESH ALL
    </button>
  </div>

  @if (stats()) {
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üë•</div>

      <div class="stat-content">
        <div class="stat-value">{{ stats()!.totalUsers }}</div>

        <div class="stat-label">TOTAL USERS</div>

        <div class="stat-sub">{{ stats()!.activeUsers }} ACTIVE</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üìù</div>

      <div class="stat-content">
        <div class="stat-value">{{ stats()!.totalPosts }}</div>

        <div class="stat-label">TOTAL POSTS</div>

        <div class="stat-sub">+{{ stats()!.postsThisMonth }} THIS MONTH</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üö®</div>

      <div class="stat-content">
        <div class="stat-value">{{ stats()!.totalReports }}</div>

        <div class="stat-label">TOTAL REPORTS</div>

        <div class="stat-sub">+{{ stats()!.reportsThisMonth }} THIS MONTH</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">üî®</div>

      <div class="stat-content">
        <div class="stat-value">{{ stats()!.totalBannedUsers }}</div>

        <div class="stat-label">BANNED USERS</div>
      </div>
    </div>
  </div>

  @if (stats()!.mostReportedUsers && stats()!.mostReportedUsers.length > 0) {
  <div class="reported-users-section">
    <h2 class="section-title">üéØ MOST REPORTED USERS</h2>

    <div class="reported-users-grid">
      @for (user of stats()!.mostReportedUsers; track user.userId) {
      <div class="reported-user-card">
        <div class="user-avatar">
          @if (user.avatar) {
          <img [src]="getMediaUrl(user.avatar)" [alt]="user.fullName" /> } @else {

          <div class="avatar-placeholder">
            {{ user.fullName[0] }}
          </div>
          }
        </div>

        <div class="user-info">
          <div class="user-name">{{ user.fullName }}</div>

          <div class="user-username">@{{ user.username }}</div>
        </div>

        <div class="report-badge">
          <span class="badge-icon">üö®</span>
          <span class="badge-count">{{ user.reportCount }}</span>
        </div>
      </div>
      }
    </div>
  </div>
  } }
  <div class="dashboard-tabs">
    <mat-tab-group class="pixel-tabs" animationDuration="0ms">
      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label"> <mat-icon>people</mat-icon> USERS ({{ usersTotal() }}) </span>
        </ng-template>

        <div class="tab-content">
          @if (isLoadingUsers() && users().length === 0) {
          <div class="loading-state">
            <mat-spinner diameter="48"></mat-spinner>
            <p>LOADING USERS...</p>
          </div>
          } @else if (users().length === 0) {
          <div class="empty-state">
            <mat-icon>people_outline</mat-icon>
            <p>NO USERS FOUND</p>
          </div>
          } @else {
          <div class="users-table">
            @for (user of users(); track user.id) {
            <div class="user-row">
              <div class="user-main">
                <div class="user-avatar-col">
                  @if (user.avatar) {
                  <img [src]="getMediaUrl(user.avatar)" [alt]="user.fullName" class="row-avatar" />
                  } @else {
                  <div class="row-avatar-placeholder">
                    {{ user.fullName[0] }}
                  </div>
                  }
                </div>

                <div class="user-details">
                  <div class="user-name-row">
                    <span class="name">{{ user.fullName }}</span>
                    @if (user.role === 'ADMIN') {
                    <span class="admin-badge">ADMIN</span> } @if (user.isBanned) {
                    <span class="banned-badge">BANNED</span> }
                  </div>

                  <div class="user-meta">
                    <span>@{{ user.username }}</span>
                    <span class="separator">‚Ä¢</span>
                    <span>{{ user.email }}</span>
                  </div>

                  @if (user.isBanned) {
                  <div class="user-stats-row banned-info">
                    <span>üö® BAN: </span>
                    <span class="ban-status">{{ getBanStatus(user) }}</span>
                  </div>
                  } @else {
                  <div class="user-stats-row">
                    <span>üìù {{ user.postsCount }} POSTS</span>
                    <span>üë• {{ user.followersCount }} FOLLOWERS</span>
                    <span>üìÖ {{ user.createdAt | timeAgo }}</span>
                  </div>
                  }
                </div>
              </div>

              <div class="user-actions">
                @if (!user.isBanned) {
                <button mat-button class="pixel-btn-danger" (click)="onBanUser(user)">
                  <mat-icon>block</mat-icon> BAN
                </button>
                } @else {
                <button mat-button class="pixel-btn-success" (click)="onBanUser(user)">
                  <mat-icon>check_circle</mat-icon>
                  UNBAN
                </button>
                }
                <button mat-icon-button [matMenuTriggerFor]="userMenu" class="menu-btn">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #userMenu="matMenu">
                  <button mat-menu-item [routerLink]="['/users/profile', user.username]">
                    <mat-icon>visibility</mat-icon>
                    <span>VIEW PROFILE</span>
                  </button>
                  <mat-divider></mat-divider>
                  @if (user.role !== 'ADMIN') {
                  <button mat-menu-item (click)="onPromoteUser(user)">
                    <mat-icon>star</mat-icon>
                    <span>PROMOTE TO ADMIN</span>
                  </button>
                  } @else {
                  <button mat-menu-item (click)="onDemoteUser(user)">
                    <mat-icon>star_border</mat-icon>
                    <span>DEMOTE TO USER</span>
                  </button>
                  }
                  <mat-divider></mat-divider>

                  <button mat-menu-item (click)="onDeleteUser(user)" class="delete-item">
                    <mat-icon>delete</mat-icon>
                    <span>DELETE USER</span>
                  </button>
                </mat-menu>
              </div>
            </div>
            @if (user === users()[users().length -1]) { @if (hasMoreUsers()) {
            <div #loadTriggerUsers class="load-trigger"></div>
            @defer (on viewport(loadTriggerUsers)) {
            {{ onUsersScrollBottom() }} } @placeholder {
            <div class="loading-more-indicator">
              <mat-spinner diameter="32"></mat-spinner>
              <p>LOADING MORE USERS...</p>
            </div>
            } } } }
          </div>
          @if (!hasMoreUsers() && !isLoadingUsers()) {
          <div class="end-of-feed">
            <mat-icon>check_circle</mat-icon>
            <p>END OF USER LIST</p>
          </div>
          } }
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label"> <mat-icon>article</mat-icon> POSTS ({{ postsTotal() }}) </span>
        </ng-template>

        <div class="tab-content">
          @if (isLoadingPosts() && posts().length === 0) {
          <div class="loading-state">
            <mat-spinner diameter="48"></mat-spinner>
            <p>LOADING POSTS...</p>
          </div>
          } @else if (posts().length === 0) {
          <div class="empty-state">
            <mat-icon>article</mat-icon>
            <p>NO POSTS FOUND</p>
          </div>
          } @else {
          <div class="posts-grid">
            @for (post of posts(); track post.id) {
            <div class="post-card" [class.hidden]="post.isHidden">
              @if (post.mediaUrl) {
              <div class="post-media">
                @if (post.mediaType === 'image') {
                <img [src]="getMediaUrl(post.mediaUrl)" [alt]="post.title" />
                } @else {
                <video [src]="getMediaUrl(post.mediaUrl)" controls></video> }
              </div>
              }
              <div class="post-content">
                <div class="post-header">
                  <h3 class="post-title">{{ post.title }}</h3>
                  @if (post.isHidden) {
                  <span class="hidden-badge">HIDDEN</span> } @if (post.reportCount &&
                  post.reportCount > 0) {
                  <span class="report-badge-post">üö® {{ post.reportCount }}</span>
                  }
                </div>

                <p class="post-excerpt">{{ post.content.substring(0, 100) }}...</p>

                <div class="post-meta">
                  <span>BY @{{ post.user.username }}</span>
                  <span class="separator">‚Ä¢</span>
                  <span>{{ post.createdAt | timeAgo }}</span>
                </div>

                <div class="post-stats">
                  <span>‚ù§Ô∏è {{ post.likesCount }}</span>
                  <span>üí¨ {{ post.commentsCount }}</span>
                </div>

                <div class="post-actions">
                  <button mat-button [routerLink]="['/posts', post.id]" class="pixel-btn-sm">
                    <mat-icon>visibility</mat-icon>
                    VIEW
                  </button>
                  @if (!post.isHidden) {
                  <button mat-button class="pixel-btn-sm" (click)="onTogglePostVisibility(post)">
                    <mat-icon>visibility_off</mat-icon>
                    HIDE
                  </button>
                  } @else {
                  <button
                    mat-button
                    class="pixel-btn-sm pixel-btn-success"
                    (click)="onTogglePostVisibility(post)"
                  >
                    <mat-icon>visibility</mat-icon>
                    UNHIDE
                  </button>
                  }
                  <button
                    mat-button
                    class="pixel-btn-sm pixel-btn-danger"
                    (click)="onDeletePost(post)"
                  >
                    <mat-icon>delete</mat-icon>
                    DELETE
                  </button>
                </div>
              </div>
            </div>
            @if (post === posts()[posts().length -1]) { @if (hasMorePosts()) {
            <div #loadTriggerPosts class="load-trigger"></div>
            @defer (on viewport(loadTriggerPosts)) {
            {{ onPostsScrollBottom() }} } @placeholder {
            <div class="loading-more-indicator">
              <mat-spinner diameter="32"></mat-spinner>
              <p>LOADING MORE POSTS...</p>
            </div>
            } } } }
          </div>
          @if (!hasMorePosts() && !isLoadingPosts()) {
          <div class="end-of-feed">
            <mat-icon>check_circle</mat-icon>
            <p>END OF POST LIST</p>
          </div>
          } }
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label"> <mat-icon>flag</mat-icon> REPORTS ({{ reportsTotal() }}) </span>
        </ng-template>

        <div class="tab-content">
                    <div class="report-filters">
            <button 
              class="filter-btn"
              [class.active]="selectedReportStatus() === 'PENDING'"
              (click)="onReportStatusChange('PENDING')">
              PENDING
            </button>
            <button 
              class="filter-btn"
              [class.active]="selectedReportStatus() === 'RESOLVED'"
              (click)="onReportStatusChange('RESOLVED')">
              RESOLVED
            </button>
            <button 
              class="filter-btn"
              [class.active]="selectedReportStatus() === 'DISMISSED'"
              (click)="onReportStatusChange('DISMISSED')">
              DISMISSED
            </button>
            <button 
              class="filter-btn"
              [class.active]="selectedReportStatus() === ''"
              (click)="onReportStatusChange('')">
              ALL
            </button>
          </div>

          @if (isLoadingReports() && reports().length === 0) {
            <div class="loading-state">
              <mat-spinner diameter="48"></mat-spinner>
              <p>LOADING REPORTS...</p>
            </div>
          } @else if (reports().length === 0) {
            <div class="empty-state">
              <mat-icon>flag</mat-icon>
              <p>NO REPORTS FOUND</p>
            </div>
          } @else {
            <div class="reports-list">
              @for (report of reports(); track report.id) {
                <div class="report-card" [class.resolved]="report.status === 'RESOLVED'" [class.dismissed]="report.status === 'DISMISSED'">
                  <div class="report-header">
                    <span class="report-status-badge" [class]="report.status.toLowerCase()">
                      {{ report.status }}
                    </span>
                    <span class="report-date">{{ report.createdAt | timeAgo }}</span>
                  </div>

                  <div class="report-content">
                    <div class="report-section">
                      <div class="section-label">REPORTER:</div>
                      <div class="user-chip">
                        <span class="chip-icon">üë§</span>
                        <span>{{ report.reporter.fullName }} (@{{ report.reporter.username }})</span>
                      </div>
                    </div>

                    <div class="report-section">
                      <div class="section-label">REPORTED USER:</div>
                      <div class="reported-user">
                        @if (report.reported.avatar) {
                          <img [src]="getMediaUrl(report.reported.avatar)" [alt]="report.reported.fullName" class="reported-avatar" />
                        } @else {
                          <div class="reported-avatar-placeholder">
                            {{ report.reported.fullName[0] }}
                          </div>
                        }
                        <div class="reported-info">
                          <div class="reported-name">{{ report.reported.fullName }}</div>
                          <div class="reported-username">@{{ report.reported.username }}</div>
                        </div>
                      </div>
                    </div>

                    @if (report.postId) {
                      <div class="report-section">
                        <div class="section-label">REPORTED POST:</div>
                        <a 
                          [routerLink]="['/posts', report.postId]" 
                          class="post-link-chip pixel-btn-sm" 
                          target="_blank">
                          <mat-icon>article</mat-icon>
                          VIEW POST #{{ report.postId }}
                        </a>
                      </div>
                    }

                    <div class="report-section">
                      <div class="section-label">REASON:</div>
                      <div class="report-reason">{{ report.reason }}</div>
                    </div>

                    @if (report.resolvedAt) {
                      <div class="report-section">
                        <div class="section-label">RESOLVED:</div>
                        <div class="resolved-info">
                          {{ report.resolvedAt | timeAgo }}
                          @if (report.resolvedBy) {
                            <span>BY {{ report.resolvedBy }}</span>
                          }
                      </div>
                    </div>
                    }
                  </div>

                  <div class="report-actions">
                    @if (report.reported.isBanned) {
                      <button 
                        mat-button 
                        class="pixel-btn-sm pixel-btn-success" 
                        (click)="onBanUser(report.reported)">
                        <mat-icon>check_circle</mat-icon>
                        UNBAN USER
                      </button>
                    } @else {
                      <button 
                        mat-button 
                        class="pixel-btn-sm pixel-btn-danger" 
                        (click)="onQuickBanUserFromReport(report)">
                        <mat-icon>block</mat-icon>
                        BAN USER
                      </button>
                    }
                    
                    @if (report.postId) {
                      @if (report.postHidden) {
                        <button 
                          mat-button 
                          class="pixel-btn-sm pixel-btn-success" 
                          (click)="onQuickHidePostFromReport(report)">
                          <mat-icon>visibility</mat-icon>
                          UNHIDE POST
                        </button>
                      } @else {
                        <button 
                          mat-button 
                          class="pixel-btn-sm pixel-btn-warning" 
                          (click)="onQuickHidePostFromReport(report)">
                          <mat-icon>visibility_off</mat-icon>
                          HIDE POST
                        </button>
                      }
                    }


                    <a 
                      mat-button 
                      class="pixel-btn-sm" 
                      [href]="'/users/profile/'+report.reported.username"
                      target="_blank">
                      <mat-icon>visibility</mat-icon>
                      VIEW USER
                  </a>
                    
                    @if (report.status === 'PENDING') {
                      <button 
                        mat-button 
                        class="pixel-btn-sm pixel-btn-success" 
                        (click)="onResolveReport(report)">
                        <mat-icon>check</mat-icon>
                        RESOLVE
                      </button>
                      <button 
                        mat-button 
                        class="pixel-btn-sm pixel-btn-warning" 
                        (click)="onDismissReport(report)">
                        <mat-icon>close</mat-icon>
                        DISMISS
                      </button>
                    }
                    
                  </div>
                </div>
                                @if (report === reports()[reports().length -1]) { @if (hasMoreReports()) {
                <div #loadTriggerReports class="load-trigger"></div>
                @defer (on viewport(loadTriggerReports)) {
                  {{ onReportsScrollBottom() }}
                } @placeholder {
                  <div class="loading-more-indicator">
                    <mat-spinner diameter="32"></mat-spinner>
                    <p>LOADING MORE REPORTS...</p>
                </div>
                } } }
              }
            </div>
                        @if (!hasMoreReports() && !isLoadingReports()) {
              <div class="end-of-feed">
                <mat-icon>check_circle</mat-icon>
                <p>END OF REPORT LIST</p>
            </div>
            }
          }
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>
</div>