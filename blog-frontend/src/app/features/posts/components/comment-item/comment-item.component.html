 <div class="comment-item" [class.nested]="depth() > 0" [style.--depth]="depth()">
      <div class="comment-main">
        <!-- Avatar -->
        <a [routerLink]="['/users/profile', comment().user.username]" class="comment-avatar">
          @if (comment().user.avatar) {
            <img [src]="getAvatarUrl(comment().user.avatar!)" [alt]="comment().user.fullName" />
          } @else {
            <div class="avatar-placeholder">
              {{ getInitials(comment().user.fullName) }}
            </div>
          }
        </a>

        <!-- Content -->
        <div class="comment-content">
          <div class="comment-header">
            <div class="comment-author-info">
              <a [routerLink]="['/users/profile', comment().user.username]" class="comment-author-name">
                {{ comment().user.fullName }}
              </a>
              <span class="comment-time">{{ comment().createdAt | timeAgo }}</span>
            </div>

            <!-- Menu -->
            @if (isAuthor()) {
              <button mat-icon-button [matMenuTriggerFor]="menu" class="comment-menu-btn">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="onEdit()">
                  <mat-icon>edit</mat-icon>
                  <span>Edit</span>
                </button>
                <button mat-menu-item (click)="deleteComment.emit(comment())" class="delete-btn">
                  <mat-icon>delete</mat-icon>
                  <span>Delete</span>
                </button>
              </mat-menu>
            }
          </div>

          <!-- Comment Text or Edit Form -->
          @if (!isEditing()) {
            <p class="comment-text">{{ comment().content }}</p>
          } @else {
            <form [formGroup]="editForm" (ngSubmit)="onSaveEdit()" class="edit-form">
              <mat-form-field appearance="outline" class="edit-input">
                <textarea
                  matInput
                  formControlName="content"
                  rows="3"
                  maxlength="500"
                ></textarea>
              </mat-form-field>
              <div class="edit-actions">
                <button type="button" mat-button (click)="onCancelEdit()" class="pixel-btn-secondary">
                  CANCEL
                </button>
                <button type="submit" mat-raised-button class="pixel-btn" [disabled]="editForm.invalid">
                  SAVE
                </button>
              </div>
            </form>
          }

          <!-- Actions -->
          <div class="comment-actions">
            <button class="action-btn" (click)="onLike()" [class.liked]="comment().isLiked">
              <mat-icon>{{ comment().isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
              @if (comment().likesCount && comment().likesCount > 0) {
                <span>{{ comment().likesCount }}</span>
              }
            </button>

            @if (depth() < maxDepth()) {
              <button class="action-btn" (click)="toggleReply()">
                <mat-icon>reply</mat-icon>
                <span>REPLY</span>
              </button>
            }

            @if (comment().repliesCount && comment().repliesCount > 0) {
              <button class="action-btn" (click)="toggleReplies()">
                <mat-icon>{{ showReplies() ? 'expand_less' : 'expand_more' }}</mat-icon>
                <span>{{ comment().repliesCount }} {{ comment().repliesCount === 1 ? 'REPLY' : 'REPLIES' }}</span>
              </button>
            }
          </div>

          <!-- Reply Form -->
          @if (showReplyForm()) {
            <form [formGroup]="replyForm" (ngSubmit)="onSubmitReply()" class="reply-form">
              <div class="form-avatar">
                @if (currentUserAvatar()) {
                  <img [src]="getAvatarUrl(currentUserAvatar()!)" alt="Your avatar" />
                } @else {
                  <div class="avatar-placeholder">U</div>
                }
              </div>
              <div class="form-content">
                <mat-form-field appearance="outline" class="reply-input">
                  <textarea
                    matInput
                    formControlName="content"
                    placeholder="Write a reply..."
                    rows="2"
                    maxlength="500"
                  ></textarea>
                </mat-form-field>
                <div class="form-actions">
                  <button type="button" mat-button (click)="toggleReply()" class="pixel-btn-secondary">
                    CANCEL
                  </button>
                  <button type="submit" mat-raised-button class="pixel-btn" [disabled]="replyForm.invalid">
                    REPLY
                  </button>
                </div>
              </div>
            </form>
          }
        </div>
      </div>

      <!-- Nested Replies -->
      @if (showReplies() && comment().replies && comment().replies!.length > 0) {
        <div class="replies-container">
          @for (reply of visibleReplies(); track reply.id) {
            <app-comment-item
              [comment]="reply"
              [depth]="depth() + 1"
              [maxDepth]="maxDepth()"
              [currentUserId]="currentUserId()"
              [currentUserAvatar]="currentUserAvatar()"
              (likeComment)="likeComment.emit($event)"
              (deleteComment)="deleteComment.emit($event)"
              (replyToComment)="replyToComment.emit($event)"
              (editComment)="editComment.emit($event)"
              (openSidebar)="openSidebar.emit($event)"
            />
          }

          <!-- Show More Button or Open Sidebar -->
          @if (hasMoreReplies()) {
            @if (depth() + 1 < maxDepth()) {
              <button class="show-more-btn pixel-btn-secondary" (click)="loadMoreReplies()">
                <mat-icon>expand_more</mat-icon>
                SHOW MORE REPLIES
              </button>
            } @else {
              <button class="open-sidebar-btn pixel-btn" (click)="onOpenSidebar()">
                <mat-icon>forum</mat-icon>
                CONTINUE THREAD â†’
              </button>
            }
          }
        </div>
      }
    </div>