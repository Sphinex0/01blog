<div class="comment-item" [class.nested]="depth() > 0" [style.--depth]="depth()">
  <div class="comment-main">
    <!-- Avatar -->
    <a [routerLink]="['/users/profile', comment().user.username]" class="comment-avatar">
      @if (comment().user.avatar) {
      <img [src]="getAvatarUrl(comment().user.avatar!)" [alt]="comment().user.fullName" />
      } @else {
      <div class="avatar-placeholder">
        {{ getInitials(comment().user.fullName) }}
      </div>
      }
    </a>

    <!-- Content -->
    <div class="comment-content">
      <div class="comment-header">
        <div class="comment-author-info">
          <a [routerLink]="['/users/profile', comment().user.username]" class="comment-author-name">
            {{ comment().user.fullName }}
          </a>
          <span class="comment-time">{{ comment().createdAt | timeAgo }}</span>
        </div>

        <!-- Menu -->
        @if (isAuthor()) {
        <button mat-icon-button [matMenuTriggerFor]="menu" class="comment-menu-btn">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="onEdit()">
            <mat-icon>edit</mat-icon>
            <span>Edit</span>
          </button>
          <button mat-menu-item (click)="deleteComment.emit(comment())" class="delete-btn">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
        }
      </div>

      <!-- Comment Text or Edit Form -->
      @if (!isEditing()) {
      <p class="comment-text">{{ comment().content }}</p>
      } @else {
      <form [formGroup]="editForm" (ngSubmit)="onSaveEdit()" class="edit-form">
        <mat-form-field appearance="outline" class="edit-input">
          <textarea matInput formControlName="content" rows="3" maxlength="500"></textarea>
        </mat-form-field>
        <div class="edit-actions">
          <button type="button" mat-button (click)="onCancelEdit()" class="pixel-btn-secondary">
            CANCEL
          </button>
          <button type="submit" mat-raised-button class="pixel-btn" [disabled]="editForm.invalid">
            SAVE
          </button>
        </div>
      </form>
      }

      <!-- Actions -->
      <div class="comment-actions">
        <button class="action-btn" (click)="onLike()" [class.liked]="comment().isLiked">
          @if(comment().isLiked){
          <mat-icon>
            <svg id="heart-solid" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <polygon
                points="23 6 23 11 22 11 22 12 21 12 21 13 20 13 20 14 19 14 19 15 18 15 18 16 17 16 17 17 16 17 16 18 15 18 15 19 14 19 14 20 13 20 13 21 11 21 11 20 10 20 10 19 9 19 9 18 8 18 8 17 7 17 7 16 6 16 6 15 5 15 5 14 4 14 4 13 3 13 3 12 2 12 2 11 1 11 1 6 2 6 2 5 3 5 3 4 4 4 4 3 10 3 10 4 11 4 11 5 13 5 13 4 14 4 14 3 20 3 20 4 21 4 21 5 22 5 22 6 23 6"
              />
            </svg>
          </mat-icon>
          }@else{
          <mat-icon>
            <svg id="heart" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path
                d="m22,6v-1h-1v-1h-1v-1h-6v1h-1v1h-2v-1h-1v-1h-6v1h-1v1h-1v1h-1v5h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h2v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-5h-1Zm-2,4v1h-1v1h-1v1h-1v1h-1v1h-1v1h-1v1h-1v1h-2v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-3h1v-1h1v-1h4v1h1v1h1v1h2v-1h1v-1h1v-1h4v1h1v1h1v3h-1Z"
              />
            </svg>
          </mat-icon>

          } @if (comment().likesCount && comment().likesCount > 0) {
          <span>{{ comment().likesCount }}</span>
          }
        </button>

        @if (depth() < maxDepth()) {
        <button class="action-btn" (click)="toggleReply()">
          <mat-icon>reply</mat-icon>
          <span class="hide-text">REPLY</span>
        </button>
        @if (comment().repliesCount && comment().repliesCount > 0) {
        <button class="action-btn" (click)="toggleReplies()">
          <mat-icon>{{ showReplies() ? 'expand_less' : 'expand_more' }}</mat-icon>
          {{ comment().repliesCount }}
          <span class="hide-text"> {{ comment().repliesCount === 1 ? 'REPLY' : 'REPLIES' }}</span>
        </button>

        } } @else {
        <button class="open-sidebar-btn pixel-btn" (click)="onOpenSidebar()">
          <mat-icon>forum</mat-icon>
          {{ comment().repliesCount > 0 ? comment().repliesCount : '' }}
          <!-- <span class="hide-text">REPLIES  THREAD →</span> -->
          <span class="hide-text">{{
            comment().repliesCount && comment().repliesCount > 0 ? ' REPLIES' : 'OPEN THREAD'
          }}</span>
        </button>
        }
      </div>

      <!-- Reply Form -->
      @if (showReplyForm()) {
      <form [formGroup]="replyForm" (ngSubmit)="onSubmitReply()" class="reply-form">
        <div class="form-avatar">
          @if (currentUserAvatar()) {
          <img [src]="getAvatarUrl(currentUserAvatar()!)" alt="Your avatar" />
          } @else {
          <div class="avatar-placeholder">U</div>
          }
        </div>
        <div class="form-content">
          <mat-form-field appearance="outline" class="reply-input">
            <textarea
              matInput
              formControlName="content"
              placeholder="Write a reply..."
              rows="2"
              maxlength="500"
            ></textarea>
          </mat-form-field>
          <div class="form-actions">
            <button type="button" mat-button (click)="toggleReply()" class="pixel-btn-secondary">
              CANCEL
            </button>
            <button
              type="submit"
              mat-raised-button
              class="pixel-btn"
              [disabled]="replyForm.invalid"
            >
              REPLY
            </button>
          </div>
        </div>
      </form>
      }
    </div>
  </div>

  <!-- Nested Replies -->
  @if (showReplies() && comment().replies && comment().replies!.length > 0) {
  <div class="replies-container">
    @for (reply of visibleReplies(); track reply.id) {
    <app-comment-item
      [comment]="reply"
      [depth]="depth() + 1"
      [maxDepth]="maxDepth()"
      [currentUserId]="currentUserId()"
      [currentUserAvatar]="currentUserAvatar()"
      (likeComment)="likeComment.emit($event)"
      (getReplies)="getReplies.emit($event)"
      (deleteComment)="deleteComment.emit($event)"
      (replyToComment)="replyToComment.emit($event)"
      (editComment)="editComment.emit($event)"
      (openSidebar)="openSidebar.emit($event)"
    />
    }

    <!-- Show More Button or Open Sidebar -->
    @if (hasMoreReplies()) {
    <!-- @if (depth() + 1 < maxDepth()) { -->
    <button class="show-more-btn pixel-btn-secondary" (click)="loadMoreReplies()">
      <mat-icon>expand_more</mat-icon>
      SHOW MORE REPLIES
    </button>
    <!-- } @else {
    <button class="open-sidebar-btn pixel-btn" (click)="onOpenSidebar()">
      <mat-icon>forum</mat-icon>
      CONTINUE THREAD →
    </button>
    } -->
    }
  </div>
  }
</div>
