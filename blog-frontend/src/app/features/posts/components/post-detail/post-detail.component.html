<div class="post-detail-container">
  <!-- Back Button -->
  <div class="back-button-wrapper">
    <button mat-icon-button (click)="goBack()" class="back-btn">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="back-text">Back to Feed</span>
  </div>

  <!-- Loading State -->
  @if (isLoadingPost()) {
  <div class="loading-state">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Loading post...</p>
  </div>
  }

  <!-- Error State -->
  @if (error() && !post()) {
  <div class="error-state">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h2>Post Not Found</h2>
    <p>{{ error() }}</p>
    <button mat-raised-button color="primary" (click)="goBack()">
      <mat-icon>home</mat-icon>
      Go to Home
    </button>
  </div>
  }

  <!-- Post Content -->
  @if (post(); as postData) {
  <article class="post-detail">
    <!-- Post Header -->
    <div class="post-header">
      <div class="author-info">
        <a [routerLink]="['/profile', postData.user.username]" class="author-avatar">
          @if (postData.user.avatar) {
          <img [src]="getMediaUrl(postData.user.avatar)" [alt]="postData.user.fullName" />
          } @else {
          <div class="avatar-placeholder">
            {{ getAuthorInitials(postData.user.fullName) }}
          </div>
          }
        </a>

        <div class="author-details">
          <a [routerLink]="['/profile', postData.user.username]" class="author-name">
            {{ postData.user.fullName }}
          </a>
          <span class="post-meta">
            &#64;{{ postData.user.username }} Â· {{ postData.createdAt | timeAgo }}
          </span>
        </div>
      </div>

      <!-- Post Menu (for author only) -->
      <button mat-icon-button [matMenuTriggerFor]="postMenu" class="post-menu-btn">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #postMenu="matMenu">
        @if (isAuthor()) {
        <button mat-menu-item (click)="onEditPost()">
          <mat-icon>edit</mat-icon>
          <span>Edit Post</span>
        </button>
        <button mat-menu-item (click)="onDeletePost()" class="delete-btn">
          <mat-icon>delete</mat-icon>
          <span>Delete Post</span>
        </button>
        }@else {
        <button mat-menu-item class="report-btn" (click)="onReportPost()">
          <mat-icon>flag</mat-icon>
          <span>Report Post</span>
        </button>
        }
      </mat-menu>
    </div>

    <!-- Post Title -->
    <h1 class="post-title">{{ postData.title }}</h1>

    <!-- Post Content -->
    <markdown class="post-content markdown-preview" [data]="postData.content"></markdown>

    <!-- <div class="post-content">
      {{ postData.content }}
    </div> -->

    <!-- Post Media -->
    @if (postData.mediaUrl) {
    <div class="post-media">
      @if (postData.mediaType === 'image') {
      <img [src]="getMediaUrl(postData.mediaUrl)" [alt]="postData.title" class="media-image" />
      } @else if (postData.mediaType === 'video') {
      <video [src]="getMediaUrl(postData.mediaUrl)" controls class="media-video">
        Your browser does not support the video tag.
      </video>
      }
    </div>
    }

    <!-- Post Stats -->
    <div class="post-stats">
      <span class="stat-item">
        <mat-icon>
          <svg id="heart-solid" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <polygon
              points="23 6 23 11 22 11 22 12 21 12 21 13 20 13 20 14 19 14 19 15 18 15 18 16 17 16 17 17 16 17 16 18 15 18 15 19 14 19 14 20 13 20 13 21 11 21 11 20 10 20 10 19 9 19 9 18 8 18 8 17 7 17 7 16 6 16 6 15 5 15 5 14 4 14 4 13 3 13 3 12 2 12 2 11 1 11 1 6 2 6 2 5 3 5 3 4 4 4 4 3 10 3 10 4 11 4 11 5 13 5 13 4 14 4 14 3 20 3 20 4 21 4 21 5 22 5 22 6 23 6"
            />
          </svg>
        </mat-icon>

        {{ postData.likesCount }} {{ postData.likesCount === 1 ? 'like' : 'likes' }}
      </span>
      <span class="stat-item">
        <mat-icon>comment</mat-icon>
        {{ postData.commentsCount }} {{ postData.commentsCount === 1 ? 'comment' : 'comments' }}
      </span>
    </div>

    <mat-divider></mat-divider>

    <!-- Post Actions -->
    <div class="post-actions">
      <button mat-button (click)="onLikePost()" [class.liked]="postData.isLiked" class="action-btn">
        @if(postData.isLiked){
        <mat-icon>
          <svg id="heart-solid" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <polygon
              points="23 6 23 11 22 11 22 12 21 12 21 13 20 13 20 14 19 14 19 15 18 15 18 16 17 16 17 17 16 17 16 18 15 18 15 19 14 19 14 20 13 20 13 21 11 21 11 20 10 20 10 19 9 19 9 18 8 18 8 17 7 17 7 16 6 16 6 15 5 15 5 14 4 14 4 13 3 13 3 12 2 12 2 11 1 11 1 6 2 6 2 5 3 5 3 4 4 4 4 3 10 3 10 4 11 4 11 5 13 5 13 4 14 4 14 3 20 3 20 4 21 4 21 5 22 5 22 6 23 6"
            />
          </svg>
        </mat-icon>
        }@else{
        <mat-icon>
          <svg id="heart" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path
              d="m22,6v-1h-1v-1h-1v-1h-6v1h-1v1h-2v-1h-1v-1h-6v1h-1v1h-1v1h-1v5h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h1v1h2v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-1h1v-5h-1Zm-2,4v1h-1v1h-1v1h-1v1h-1v1h-1v1h-1v1h-1v1h-2v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-1h-1v-3h1v-1h1v-1h4v1h1v1h1v1h2v-1h1v-1h1v-1h4v1h1v1h1v3h-1Z"
            />
          </svg>
        </mat-icon>

        }
        <span>{{ postData.isLiked ? 'Liked' : 'Like' }}</span>
      </button>

      <button mat-button class="action-btn" (click)="onSharePost()">
        <mat-icon>share</mat-icon>
        <span>Share</span>
      </button>

      <!-- <button mat-button class="action-btn">
        <mat-icon>bookmark_border</mat-icon>
        <span>Save</span>
      </button> -->
    </div>

    <mat-divider></mat-divider>

    <!-- Comments Section -->
    <app-comments-section
      [comments]="comments()"
      [totalCount]="post()?.commentsCount || 0"
      [isLoading]="isLoadingComments()"
      [isSubmitting]="isSubmittingComment()"
      [currentUserId]="currentUser()?.id || null"
      [currentUserAvatar]="currentUser()?.avatar || null"
      (submitComment)="onSubmitComment($event)"
      (likeComment)="onLikeComment($event)"
      (getReplies)="onGetReplies($event)"
      (getComments)="loadComments()"
      (deleteComment)="onDeleteComment($event)"
      (replyToComment)="onReplyToComment($event)"
      (editComment)="onEditComment($event)"
    />
  </article>
  }
</div>
